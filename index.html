<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FlowReceipt — Pending Slip + Receipts</title>
  <style>
    :root{
      --bg0:#06140b; --bg1:#062a14;
      --cardA:rgba(255,255,255,.07); --cardB:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.14);
      --text:#ecfff2; --muted:rgba(236,255,242,.70);
      --good:#62ffb6; --warn:#ffd86b; --bad:#ff6b6b; --gold:#ffd36a;
      --shadow:0 18px 70px rgba(0,0,0,.42);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(92,255,140,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 10%, rgba(255,211,106,.16), transparent 55%),
        radial-gradient(900px 600px at 45% 85%, rgba(0,180,90,.20), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
      overflow-x:hidden;
    }
    .sparkles::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.10), transparent 18%),
        radial-gradient(circle at 80% 30%, rgba(255,211,106,.12), transparent 16%),
        radial-gradient(circle at 35% 75%, rgba(98,255,182,.10), transparent 18%),
        radial-gradient(circle at 70% 80%, rgba(255,255,255,.08), transparent 18%),
        radial-gradient(circle at 55% 45%, rgba(255,211,106,.08), transparent 18%);
      opacity:.85;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 96px}
    .top{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(6,20,11,.92), rgba(6,20,11,.65), transparent);
      padding:12px 0 10px;
    }
    .brand{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .logo{display:flex; align-items:center; gap:10px;}
    .mark{
      width:38px;height:38px;border-radius:14px;
      background: linear-gradient(180deg, rgba(98,255,182,.28), rgba(255,211,106,.18));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 40px rgba(0,0,0,.30);
      position:relative; overflow:hidden;
    }
    .mark:after{
      content:""; position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 55%);
      transform: rotate(18deg);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      box-shadow: 0 12px 35px rgba(0,0,0,.20);
      font-weight:650;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color: rgba(98,255,182,.45);
      background: linear-gradient(180deg, rgba(98,255,182,.25), rgba(255,255,255,.06));
    }
    .btn.gold{
      border-color: rgba(255,211,106,.45);
      background: linear-gradient(180deg, rgba(255,211,106,.22), rgba(255,255,255,.06));
    }

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    .card{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.07));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(600px 260px at 20% 0%, rgba(98,255,182,.10), transparent 60%),
                  radial-gradient(600px 260px at 85% 0%, rgba(255,211,106,.09), transparent 60%);
      opacity:.9;
    }
    .card .hd{
      position:relative;
      padding:14px 14px 10px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .title{font-size:14px;margin:0}
    .hint{font-size:12px;color:var(--muted)}
    .card .bd{position:relative; padding:0 14px 14px}

    .chip{
      display:inline-flex;gap:6px;align-items:center;
      padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;color:var(--muted);
    }
    .chip b{color:var(--text)}
    .mono{font-variant-numeric:tabular-nums}

    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .kpi{
      grid-column: span 6;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px;
    }
    @media(min-width:860px){
      .kpi{grid-column: span 3;}
      .card.half{grid-column: span 6;}
    }
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:20px;font-weight:850;margin-top:6px}

    .form{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .field{grid-column: span 12}
    @media(min-width:860px){
      .field.half{grid-column: span 6}
      .field.third{grid-column: span 4}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      outline:none;
    }

    .tog{display:flex;gap:8px;flex-wrap:wrap}
    .tog button{
      flex:1; min-width:150px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color:var(--text);
      padding:10px 12px;border-radius:999px;cursor:pointer;
      font-weight:700;
    }
    .tog button.active{
      border-color: rgba(255,211,106,.55);
      background: rgba(255,211,106,.16);
    }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      border-radius:18px;
      padding:12px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .item .l{min-width:220px}
    .item .t{font-weight:800}
    .item .m{font-size:12px;color:var(--muted);margin-top:4px}
    .item .r{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .tag.good{border-color:rgba(98,255,182,.40);color:var(--good)}
    .tag.warn{border-color:rgba(255,216,107,.42);color:var(--warn)}
    .tag.bad{border-color:rgba(255,107,107,.42);color:var(--bad)}

    .link{
      color:rgba(255,211,106,.95);
      cursor:pointer;
      text-decoration:underline;
      font-size:12px;
      font-weight:750;
      user-select:none;
    }

    .footerbar{
      position:fixed;left:0;right:0;bottom:0;z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(to top, rgba(6,20,11,.92), rgba(6,20,11,.62), transparent);
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .footerbar .row{justify-content:center}
  </style>
</head>

<body class="sparkles">
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">
          <div class="mark" aria-hidden="true"></div>
          <div>
            <h1>FlowReceipt</h1>
            <div class="sub">Client • Job • Pending Slip • Advance • Payment Receipt</div>
          </div>
        </div>
        <div class="row">
          <button class="btn gold" id="btnExport">Export JSON</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card">
        <div class="hd">
          <div>
            <p class="title">Dashboard</p>
            <div class="hint">এই মাসের ইনকাম, বকেয়া, এডভান্স ব্যালান্স</div>
          </div>
          <div class="chip">Today <b id="todayTxt"></b></div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="lab">This Month Income</div>
              <div class="val mono" id="kpiMonthIncome">৳ 0</div>
            </div>
            <div class="kpi">
              <div class="lab">Pending Amount</div>
              <div class="val mono" id="kpiPending">৳ 0</div>
            </div>
            <div class="kpi">
              <div class="lab">Advance Credit (All Clients)</div>
              <div class="val mono" id="kpiAdvance">৳ 0</div>
            </div>
            <div class="kpi">
              <div class="lab">Jobs Count</div>
              <div class="val mono" id="kpiJobs">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card half">
        <div class="hd">
          <div>
            <p class="title">Add Client</p>
            <div class="hint">ক্লায়েন্ট যুক্ত করুন</div>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div class="field half">
              <label>Client Name</label>
              <input id="cName" placeholder="যেমন: Rahim Traders" />
            </div>
            <div class="field half">
              <label>Phone (optional)</label>
              <input id="cPhone" placeholder="01XXXXXXXXX" />
            </div>
            <div class="field">
              <label>Note (optional)</label>
              <input id="cNote" placeholder="কী কাজ, কোন শর্ত..." />
            </div>
            <div class="field">
              <button class="btn primary" id="btnAddClient">Save Client</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card half">
        <div class="hd">
          <div>
            <p class="title">Add Job</p>
            <div class="hint">Fixed বা Per Piece প্রাইস</div>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div class="field">
              <label>Select Client</label>
              <select id="jClient"></select>
            </div>
            <div class="field">
              <label>Job Title</label>
              <input id="jTitle" placeholder="যেমন: Logo Design / Print 200pcs" />
            </div>

            <div class="field">
              <label>Price Type</label>
              <div class="tog">
                <button type="button" id="btnFixed" class="active">Fixed Price</button>
                <button type="button" id="btnPiece">Per Piece</button>
              </div>
            </div>

            <div class="field half" id="fixedWrap">
              <label>Price (৳)</label>
              <input id="jFixedPrice" type="number" min="0" step="1" placeholder="12000" />
            </div>

            <div class="field half" id="unitWrap" style="display:none">
              <label>Unit Price (৳)</label>
              <input id="jUnitPrice" type="number" min="0" step="1" placeholder="50" />
            </div>
            <div class="field half" id="qtyWrap" style="display:none">
              <label>Quantity (pcs)</label>
              <input id="jQty" type="number" min="0" step="1" placeholder="200" />
            </div>

            <div class="field half">
              <label>Start Date</label>
              <input id="jStart" type="date" />
            </div>
            <div class="field half">
              <label>Payment Due Date</label>
              <input id="jDue" type="date" />
            </div>

            <div class="field third">
              <label>Status</label>
              <select id="jStatus">
                <option value="In Progress">In Progress</option>
                <option value="Delivered">Delivered</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <div class="field third">
              <label>Payment Method (default)</label>
              <select id="jMethod">
                <option>Bkash</option><option>Nagad</option><option>Rocket</option><option>Upay</option>
                <option>Bank Transfer</option><option>Cash</option><option>Other</option>
              </select>
            </div>
            <div class="field third">
              <label>Total Price (Auto)</label>
              <input id="jTotalAuto" disabled />
            </div>

            <div class="field">
              <button class="btn primary" id="btnAddJob">Save Job</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card half">
        <div class="hd">
          <div>
            <p class="title">Add Advance</p>
            <div class="hint">Advance save করলে Advance Receipt হবে</div>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div class="field">
              <label>Select Client</label>
              <select id="aClient"></select>
            </div>
            <div class="field half">
              <label>Advance Amount (৳)</label>
              <input id="aAmount" type="number" min="0" step="1" placeholder="2000" />
            </div>
            <div class="field half">
              <label>Date</label>
              <input id="aDate" type="date" />
            </div>
            <div class="field">
              <label>Note</label>
              <input id="aNote" placeholder="যেমন: অর্ডার কনফার্ম" />
            </div>
            <div class="field">
              <button class="btn primary" id="btnAddAdvance">Save Advance</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card half">
        <div class="hd">
          <div>
            <p class="title">Receive Payment (Payment Receipt)</p>
            <div class="hint">Use Advance optional + Receipt + PDF + Share</div>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div class="field">
              <label>Select Job</label>
              <select id="pJob"></select>
            </div>

            <div class="field">
              <label>Advance Apply</label>
              <div class="tog">
                <button type="button" id="btnUseAdv" class="active">Use Advance</button>
                <button type="button" id="btnNoAdv">Don't Use</button>
              </div>
            </div>

            <div class="field half">
              <label>Paid Now (৳)</label>
              <input id="pAmount" type="number" min="0" step="1" placeholder="5000" />
            </div>
            <div class="field half">
              <label>Payment Method</label>
              <select id="pMethod">
                <option>Bkash</option><option>Nagad</option><option>Rocket</option><option>Upay</option>
                <option>Bank Transfer</option><option>Cash</option><option>Other</option>
              </select>
            </div>
            <div class="field half">
              <label>Txn ID (optional)</label>
              <input id="pTxn" placeholder="8N7K..." />
            </div>
            <div class="field half">
              <label>Date</label>
              <input id="pDate" type="date" />
            </div>

            <div class="field">
              <label>Advance Preview</label>
              <input id="pAdvanceInfo" disabled />
              <div class="hint">Job select করলে advance এবং কতটা কাটবে তা দেখাবে</div>
            </div>

            <div class="field">
              <label>Note</label>
              <input id="pNote" placeholder="যেমন: 2nd installment" />
            </div>

            <div class="field">
              <button class="btn primary" id="btnReceive">Create Payment Receipt</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <p class="title">Jobs List</p>
            <div class="hint">Pending/Partial/Paid + Pending Slip (Due Receipt)</div>
          </div>
          <div class="chip">Filter <b id="filterTxt">All</b></div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:10px">
            <button class="btn" data-filter="all">All</button>
            <button class="btn" data-filter="pending">Pending</button>
            <button class="btn" data-filter="partial">Partial</button>
            <button class="btn" data-filter="paid">Paid</button>
          </div>
          <div class="list" id="jobsList"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <p class="title">Payment Receipts</p>
            <div class="hint">Share / PDF / Copy</div>
          </div>
        </div>
        <div class="bd"><div class="list" id="receiptList"></div></div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <p class="title">Advance Receipts</p>
            <div class="hint">Share / PDF / Copy</div>
          </div>
        </div>
        <div class="bd"><div class="list" id="advanceReceiptList"></div></div>
      </div>

    </div>
  </div>

  <div class="footerbar">
    <div class="row">
      <span class="chip">Tip <b>PDF:</b> PDF → Print → Save as PDF</span>
      <span class="chip">Tip <b>Share:</b> Share → WhatsApp/Email</span>
    </div>
  </div>

<script>
/* ---------- Storage ---------- */
const KEY="flowreceipt_pending_slip_v1";
function loadDB(){ try{ return JSON.parse(localStorage.getItem(KEY)) || null }catch(e){ return null } }
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+Date.now().toString(16); }
function money(n){ n=Number(n||0); return "৳ " + n.toLocaleString("en-US"); }
function todayISO(){ return new Date().toISOString().slice(0,10); }

let db = loadDB();
if(!db){
  db = { clients:[], jobs:[], advances:[], payments:[], receipts:[], advanceReceipts:[] };
  saveDB(db);
}
db.clients = db.clients || [];
db.jobs = db.jobs || [];
db.advances = db.advances || [];
db.payments = db.payments || [];
db.receipts = db.receipts || [];
db.advanceReceipts = db.advanceReceipts || [];

/* ---------- Helpers ---------- */
function clientAdvanceBalance(clientId){
  const adds = db.advances.filter(a=>a.clientId===clientId).reduce((s,a)=>s+Number(a.amount||0),0);
  const used = db.payments.filter(p=>p.clientId===clientId).reduce((s,p)=>s+Number(p.advanceUsed||0),0);
  return Math.max(0, adds - used);
}
function jobTotalPrice(job){
  return job.priceType==="piece" ? Number(job.unitPrice||0)*Number(job.qty||0) : Number(job.fixedPrice||0);
}
function jobPaidTotal(jobId){
  return db.payments.filter(p=>p.jobId===jobId).reduce((s,p)=>s+Number(p.amount||0),0);
}
function jobAdvanceUsed(jobId){
  return db.payments.filter(p=>p.jobId===jobId).reduce((s,p)=>s+Number(p.advanceUsed||0),0);
}
function jobDue(job){
  const total = jobTotalPrice(job);
  const paid = jobPaidTotal(job.id);
  const advUsed = jobAdvanceUsed(job.id);
  return Math.max(0, total - (paid + advUsed));
}
function jobPayStatus(job){
  const total = jobTotalPrice(job);
  const paidAll = jobPaidTotal(job.id) + jobAdvanceUsed(job.id);
  if(total<=0 || paidAll<=0) return "pending";
  if(paidAll>=total) return "paid";
  return "partial";
}
function monthIncome(isoMonth){
  return db.payments.filter(p => (p.date||"").slice(0,7)===isoMonth).reduce((s,p)=>s+Number(p.amount||0),0);
}
function pendingAll(){ return db.jobs.reduce((s,j)=>s+jobDue(j),0); }
function allAdvance(){ return db.clients.reduce((s,c)=>s+clientAdvanceBalance(c.id),0); }

/* ---------- UI Refs ---------- */
const el = (id)=>document.getElementById(id);
el("todayTxt").textContent = new Date().toLocaleDateString("bn-BD");

const kpiMonthIncome = el("kpiMonthIncome");
const kpiPending = el("kpiPending");
const kpiAdvance = el("kpiAdvance");
const kpiJobs = el("kpiJobs");

const cName=el("cName"), cPhone=el("cPhone"), cNote=el("cNote");
const btnAddClient=el("btnAddClient");

const jClient=el("jClient"), jTitle=el("jTitle");
const btnFixed=el("btnFixed"), btnPiece=el("btnPiece");
const fixedWrap=el("fixedWrap"), unitWrap=el("unitWrap"), qtyWrap=el("qtyWrap");
const jFixedPrice=el("jFixedPrice"), jUnitPrice=el("jUnitPrice"), jQty=el("jQty");
const jStart=el("jStart"), jDue=el("jDue"), jStatus=el("jStatus"), jMethod=el("jMethod"), jTotalAuto=el("jTotalAuto");
const btnAddJob=el("btnAddJob");

const aClient=el("aClient"), aAmount=el("aAmount"), aDate=el("aDate"), aNote=el("aNote");
const btnAddAdvance=el("btnAddAdvance");

const pJob=el("pJob"), pAmount=el("pAmount"), pMethod=el("pMethod"), pTxn=el("pTxn"), pDate=el("pDate"), pAdvanceInfo=el("pAdvanceInfo"), pNote=el("pNote");
const btnReceive=el("btnReceive");
const btnUseAdv = el("btnUseAdv");
const btnNoAdv  = el("btnNoAdv");

const jobsList=el("jobsList");
const receiptList=el("receiptList");
const advanceReceiptList=el("advanceReceiptList");
const filterTxt=el("filterTxt");
const btnReset=el("btnReset");
const btnExport=el("btnExport");

/* ---------- State ---------- */
let priceType="fixed";
let filter="all";
let useAdvance = true;

/* ---------- Defaults ---------- */
jStart.value = todayISO();
jDue.value = todayISO();
aDate.value = todayISO();
pDate.value = todayISO();

/* ---------- Render ---------- */
function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
}

function renderSelectors(){
  const optsClients = db.clients.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
  jClient.innerHTML = optsClients || `<option value="">(Add a client first)</option>`;
  aClient.innerHTML = optsClients || `<option value="">(Add a client first)</option>`;

  const jobOptions = db.jobs.map(j=>{
    const c = db.clients.find(x=>x.id===j.clientId);
    const total = jobTotalPrice(j);
    const due = jobDue(j);
    return `<option value="${j.id}">${escapeHtml(c?c.name:"Client")} — ${escapeHtml(j.title)} (${money(total)} | Due ${money(due)})</option>`;
  }).join("");
  pJob.innerHTML = jobOptions || `<option value="">(Add a job first)</option>`;
}

function renderKPIs(){
  const ym = new Date().toISOString().slice(0,7);
  kpiMonthIncome.textContent = money(monthIncome(ym));
  kpiPending.textContent = money(pendingAll());
  kpiAdvance.textContent = money(allAdvance());
  kpiJobs.textContent = String(db.jobs.length);
}

function renderJobs(){
  let list = db.jobs.slice().sort((a,b)=>(a.dueDate||"").localeCompare(b.dueDate||""));
  if(filter!=="all") list = list.filter(j=>jobPayStatus(j)===filter);
  filterTxt.textContent = filter==="all" ? "All" : filter[0].toUpperCase()+filter.slice(1);

  if(list.length===0){
    jobsList.innerHTML = `<div class="item"><div class="l"><div class="t">No jobs</div><div class="m">এখনো কোনো কাজ নেই</div></div></div>`;
    return;
  }

  jobsList.innerHTML = list.map(j=>{
    const c = db.clients.find(x=>x.id===j.clientId);
    const total = jobTotalPrice(j);
    const due = jobDue(j);
    const ps = jobPayStatus(j);
    const tagClass = ps==="paid" ? "good" : ps==="partial" ? "warn" : "bad";
    const tagText  = ps==="paid" ? "Paid" : ps==="partial" ? "Partial" : "Pending";

    const priceLine = j.priceType==="piece"
      ? `Per Piece: ৳${Number(j.unitPrice||0)} × ${Number(j.qty||0)} pcs`
      : `Fixed: ৳${Number(j.fixedPrice||0)}`;

    return `
      <div class="item">
        <div class="l">
          <div class="t">${escapeHtml(c?c.name:"Client")} • ${escapeHtml(j.title)}</div>
          <div class="m">${escapeHtml(priceLine)} • Due Date: ${escapeHtml(j.dueDate||"-")} • Status: ${escapeHtml(j.status||"-")}</div>
        </div>
        <div class="r">
          <span class="tag ${tagClass}">${tagText}</span>
          <span class="tag mono">Total ${money(total)}</span>
          <span class="tag mono">Due ${money(due)}</span>

          <span class="link" onclick="sharePendingSlip('${j.id}')">Pending Share</span>
          <span class="link" onclick="printPendingSlip('${j.id}')">Pending PDF</span>
          <span class="link" onclick="copyPendingSlip('${j.id}')">Pending Copy</span>

          <span class="link" onclick="deleteJob('${j.id}')">Delete</span>
        </div>
      </div>
    `;
  }).join("");
}

function renderReceipts(){
  const list = db.receipts.slice().sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")).slice(0,14);
  if(list.length===0){
    receiptList.innerHTML = `<div class="item"><div class="l"><div class="t">No payment receipts</div><div class="m">পেমেন্ট নিলেই রিসিট তৈরি হবে</div></div></div>`;
    return;
  }
  receiptList.innerHTML = list.map(r=>{
    const c = db.clients.find(x=>x.id===r.clientId);
    const j = db.jobs.find(x=>x.id===r.jobId);
    return `
      <div class="item">
        <div class="l">
          <div class="t">Payment Receipt #${escapeHtml(r.receiptNo)}</div>
          <div class="m">${escapeHtml(c?c.name:"Client")} • ${escapeHtml(j?j.title:"Job")} • ${escapeHtml(r.date)} • ${escapeHtml(r.method)} ${r.txnId?("• Txn: "+escapeHtml(r.txnId)):""}</div>
        </div>
        <div class="r">
          <span class="tag mono">Paid ${money(r.paidNow)}</span>
          <span class="tag mono">Adv ${money(r.advanceUsed)}</span>
          <span class="tag mono">Due ${money(r.remainingDue)}</span>
          <span class="link" onclick="shareReceipt('${r.id}')">Share</span>
          <span class="link" onclick="printReceipt('${r.id}')">PDF</span>
          <span class="link" onclick="copyReceipt('${r.id}')">Copy</span>
          <span class="link" onclick="deleteReceipt('${r.id}')">Delete</span>
        </div>
      </div>
    `;
  }).join("");
}

function renderAdvanceReceipts(){
  const list = (db.advanceReceipts||[]).slice().sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")).slice(0,14);
  if(list.length===0){
    advanceReceiptList.innerHTML = `<div class="item"><div class="l"><div class="t">No advance receipts</div><div class="m">Advance save করলে এখানে receipt আসবে</div></div></div>`;
    return;
  }
  advanceReceiptList.innerHTML = list.map(r=>{
    const c = db.clients.find(x=>x.id===r.clientId);
    return `
      <div class="item">
        <div class="l">
          <div class="t">Advance Receipt #${escapeHtml(r.receiptNo)}</div>
          <div class="m">${escapeHtml(c?c.name:"Client")} • ${escapeHtml(r.date)}</div>
        </div>
        <div class="r">
          <span class="tag mono">Amount ${money(r.amount)}</span>
          <span class="link" onclick="shareAdvanceReceipt('${r.id}')">Share</span>
          <span class="link" onclick="printAdvanceReceipt('${r.id}')">PDF</span>
          <span class="link" onclick="copyAdvanceReceipt('${r.id}')">Copy</span>
          <span class="link" onclick="deleteAdvanceReceipt('${r.id}')">Delete</span>
        </div>
      </div>
    `;
  }).join("");
}

function renderAll(){
  renderSelectors();
  renderKPIs();
  renderJobs();
  renderReceipts();
  renderAdvanceReceipts();
  updateTotalAuto();
  updateAdvancePreview();
}

/* ---------- Price UI ---------- */
function setPriceType(t){
  priceType=t;
  btnFixed.classList.toggle("active", t==="fixed");
  btnPiece.classList.toggle("active", t==="piece");
  fixedWrap.style.display = t==="fixed" ? "block" : "none";
  unitWrap.style.display = t==="piece" ? "block" : "none";
  qtyWrap.style.display  = t==="piece" ? "block" : "none";
  updateTotalAuto();
}
function updateTotalAuto(){
  let total=0;
  if(priceType==="fixed") total = Number(jFixedPrice.value||0);
  else total = Number(jUnitPrice.value||0) * Number(jQty.value||0);
  jTotalAuto.value = money(total);
}

/* ---------- Advance toggle ---------- */
function setUseAdvance(v){
  useAdvance = v;
  btnUseAdv.classList.toggle("active", v===true);
  btnNoAdv.classList.toggle("active", v===false);
  updateAdvancePreview();
}
btnUseAdv.addEventListener("click", ()=>setUseAdvance(true));
btnNoAdv.addEventListener("click", ()=>setUseAdvance(false));

/* ---------- Advance preview ---------- */
function updateAdvancePreview(){
  const jobId = pJob.value;
  const job = db.jobs.find(x=>x.id===jobId);
  if(!job){ pAdvanceInfo.value="—"; return; }
  const bal = clientAdvanceBalance(job.clientId);
  const due = jobDue(job);
  const paidNow = Number(pAmount.value||0);
  const remainingAfterCash = Math.max(0, due - paidNow);
  const willUse = useAdvance ? Math.min(bal, remainingAfterCash) : 0;
  pAdvanceInfo.value = `Advance: ${money(bal)} • Due: ${money(due)} • Cash: ${money(paidNow)} • Will use: ${money(willUse)}`;
}

/* ---------- Actions ---------- */
btnAddClient.addEventListener("click", ()=>{
  const name = (cName.value||"").trim();
  if(!name){ alert("Client name দিন"); return; }
  db.clients.push({
    id:uid("c"),
    name,
    phone:(cPhone.value||"").trim(),
    note:(cNote.value||"").trim(),
    createdAt:new Date().toISOString()
  });
  saveDB(db);
  cName.value=""; cPhone.value=""; cNote.value="";
  renderAll();
});

btnFixed.addEventListener("click", ()=>setPriceType("fixed"));
btnPiece.addEventListener("click", ()=>setPriceType("piece"));
[jFixedPrice,jUnitPrice,jQty].forEach(x=>x.addEventListener("input", updateTotalAuto));

btnAddJob.addEventListener("click", ()=>{
  const clientId = jClient.value;
  if(!clientId){ alert("Client নির্বাচন করুন"); return; }
  const title = (jTitle.value||"").trim();
  if(!title){ alert("Job title দিন"); return; }

  let fixedPrice=0, unitPrice=0, qty=0;
  if(priceType==="fixed"){
    fixedPrice = Number(jFixedPrice.value||0);
    if(fixedPrice<=0){ alert("Fixed price দিন"); return; }
  }else{
    unitPrice = Number(jUnitPrice.value||0);
    qty = Number(jQty.value||0);
    if(unitPrice<=0 || qty<=0){ alert("Unit price এবং Quantity দিন"); return; }
  }

  db.jobs.push({
    id:uid("j"),
    clientId,
    title,
    priceType,
    fixedPrice,
    unitPrice,
    qty,
    startDate: jStart.value || todayISO(),
    dueDate: jDue.value || todayISO(),
    status: jStatus.value || "In Progress",
    methodDefault: jMethod.value || "Bkash",
    createdAt: new Date().toISOString()
  });
  saveDB(db);
  jTitle.value="";
  jFixedPrice.value=""; jUnitPrice.value=""; jQty.value="";
  setPriceType("fixed");
  renderAll();
});

btnAddAdvance.addEventListener("click", ()=>{
  const clientId = aClient.value;
  if(!clientId){ alert("Client নির্বাচন করুন"); return; }
  const amount = Number(aAmount.value||0);
  if(amount<=0){ alert("Advance amount দিন"); return; }

  db.advances.push({
    id:uid("a"),
    clientId,
    amount,
    date: aDate.value || todayISO(),
    note: (aNote.value||"").trim(),
    createdAt: new Date().toISOString()
  });

  const advReceiptNo = "A" + String((db.advanceReceipts||[]).length + 1).padStart(5,"0");
  db.advanceReceipts.push({
    id: uid("ar"),
    receiptNo: advReceiptNo,
    clientId,
    amount,
    date: aDate.value || todayISO(),
    note: (aNote.value||"").trim(),
    createdAt: new Date().toISOString()
  });

  saveDB(db);
  aAmount.value=""; aNote.value="";
  renderAll();
});

pJob.addEventListener("change", ()=>{
  const job = db.jobs.find(x=>x.id===pJob.value);
  if(job) pMethod.value = job.methodDefault || "Bkash";
  updateAdvancePreview();
});
pAmount.addEventListener("input", updateAdvancePreview);

btnReceive.addEventListener("click", ()=>{
  const jobId = pJob.value;
  const job = db.jobs.find(x=>x.id===jobId);
  if(!job){ alert("Job নির্বাচন করুন"); return; }

  const paidNow = Number(pAmount.value||0);
  if(paidNow<0){ alert("Paid amount সঠিক দিন"); return; }

  const total = jobTotalPrice(job);
  const dueBefore = jobDue(job);
  const bal = clientAdvanceBalance(job.clientId);

  const remainingAfterCash = Math.max(0, dueBefore - paidNow);
  const advanceUsed = useAdvance ? Math.min(bal, remainingAfterCash) : 0;

  db.payments.push({
    id: uid("p"),
    clientId: job.clientId,
    jobId,
    amount: paidNow,
    method: pMethod.value || "Bkash",
    txnId: (pTxn.value||"").trim(),
    date: pDate.value || todayISO(),
    note: (pNote.value||"").trim(),
    advanceUsed,
    createdAt: new Date().toISOString()
  });

  const remainingDue = Math.max(0, dueBefore - (advanceUsed + paidNow));
  const receiptNo = String(db.receipts.length + 1).padStart(5,"0");

  db.receipts.push({
    id: uid("r"),
    receiptNo,
    clientId: job.clientId,
    jobId,
    date: pDate.value || todayISO(),
    method: pMethod.value || "Bkash",
    txnId: (pTxn.value||"").trim(),
    paidNow,
    advanceUsed,
    totalPrice: total,
    remainingDue,
    note: (pNote.value||"").trim(),
    createdAt: new Date().toISOString()
  });

  if(remainingDue===0) job.status = "Closed";

  saveDB(db);
  pAmount.value=""; pTxn.value=""; pNote.value="";
  renderAll();
});

document.querySelectorAll("[data-filter]").forEach(b=>{
  b.addEventListener("click", ()=>{
    filter = b.getAttribute("data-filter");
    renderJobs();
  });
});

btnReset.addEventListener("click", ()=>{
  const ok = confirm("সব ডাটা মুছে যাবে। নিশ্চিত?");
  if(!ok) return;
  localStorage.removeItem(KEY);
  db = { clients:[], jobs:[], advances:[], payments:[], receipts:[], advanceReceipts:[] };
  saveDB(db);
  renderAll();
});

btnExport.addEventListener("click", ()=>{
  const data = JSON.stringify(db,null,2);
  navigator.clipboard.writeText(data).then(()=>alert("Export JSON copied ✅"));
});

/* ---------- Pending Slip (Due Receipt) ---------- */
function buildPendingSlipText(jobId){
  const j = db.jobs.find(x=>x.id===jobId);
  if(!j) return "";
  const c = db.clients.find(x=>x.id===j.clientId);

  const total = jobTotalPrice(j);
  const paidCash = jobPaidTotal(j.id);
  const advUsed = jobAdvanceUsed(j.id);
  const due = jobDue(j);
  const advBal = clientAdvanceBalance(j.clientId);

  const priceLine = j.priceType==="piece"
    ? `Per Piece: ৳${Number(j.unitPrice||0)} × ${Number(j.qty||0)} pcs`
    : `Fixed: ৳${Number(j.fixedPrice||0)}`;

  return `PENDING PAYMENT SLIP (DUE RECEIPT)
Client: ${c?c.name:""}
Phone: ${c?.phone || ""}
Job: ${j.title}
Price: ${priceLine}
Start: ${j.startDate || "-"} | Due Date: ${j.dueDate || "-"}
Work Status: ${j.status || "-"}

Total: ${money(total)}
Paid (Cash): ${money(paidCash)}
Advance Used: ${money(advUsed)}
Remaining Due: ${money(due)}
Client Advance Balance: ${money(advBal)}

Note: ${c?.note || ""}`;
}

async function sharePendingSlip(jobId){
  const text = buildPendingSlipText(jobId);
  if(!text){ alert("Job not found"); return; }

  if(navigator.share){
    try{ await navigator.share({ title:"Pending Payment Slip", text }); return; }catch(e){}
  }
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}
function copyPendingSlip(jobId){
  const text = buildPendingSlipText(jobId);
  if(!text){ alert("Job not found"); return; }
  navigator.clipboard.writeText(text).then(()=>alert("Pending slip copied ✅"));
}
function printPendingSlip(jobId){
  const j = db.jobs.find(x=>x.id===jobId);
  if(!j){ alert("Job not found"); return; }
  const c = db.clients.find(x=>x.id===j.clientId);

  const total = jobTotalPrice(j);
  const paidCash = jobPaidTotal(j.id);
  const advUsed = jobAdvanceUsed(j.id);
  const due = jobDue(j);
  const advBal = clientAdvanceBalance(j.clientId);

  const priceLine = j.priceType==="piece"
    ? `Per Piece: ৳${Number(j.unitPrice||0)} × ${Number(j.qty||0)} pcs`
    : `Fixed: ৳${Number(j.fixedPrice||0)}`;

  const html = `
  <html><head><meta charset="utf-8">
  <title>Pending Payment Slip</title>
  <style>
    body{font-family:Arial;padding:18px}
    .box{border:1px solid #ddd;border-radius:12px;padding:16px;max-width:680px}
    h2{margin:0 0 10px}
    .row{display:flex;justify-content:space-between;margin:6px 0;gap:10px}
    .muted{color:#555}
    hr{border:none;border-top:1px solid #eee;margin:12px 0}
  </style>
  </head><body>
    <div class="box">
      <h2>Pending Payment Slip (Due Receipt)</h2>
      <div class="row"><div class="muted">Client</div><div>${(c?c.name:"")}</div></div>
      <div class="row"><div class="muted">Phone</div><div>${(c?.phone || "")}</div></div>
      <div class="row"><div class="muted">Job</div><div>${j.title}</div></div>
      <div class="row"><div class="muted">Price</div><div>${priceLine}</div></div>
      <div class="row"><div class="muted">Start</div><div>${j.startDate || "-"}</div></div>
      <div class="row"><div class="muted">Due Date</div><div>${j.dueDate || "-"}</div></div>
      <div class="row"><div class="muted">Work Status</div><div>${j.status || "-"}</div></div>

      <hr/>

      <div class="row"><div class="muted">Total</div><div>${money(total)}</div></div>
      <div class="row"><div class="muted">Paid (Cash)</div><div>${money(paidCash)}</div></div>
      <div class="row"><div class="muted">Advance Used</div><div>${money(advUsed)}</div></div>
      <div class="row"><div class="muted"><b>Remaining Due</b></div><div><b>${money(due)}</b></div></div>

      <hr/>
      <div class="row"><div class="muted">Client Advance Balance</div><div>${money(advBal)}</div></div>
    </div>
    <script>window.print();<\/script>
  </body></html>`;

  const w = window.open("", "_blank");
  w.document.open(); w.document.write(html); w.document.close();
}

/* ---------- Payment Receipt actions ---------- */
function buildReceiptText(r){
  const c = db.clients.find(x=>x.id===r.clientId);
  const j = db.jobs.find(x=>x.id===r.jobId);
  return `PAYMENT RECEIPT #${r.receiptNo}
Client: ${c?c.name:""}
Job: ${j?j.title:""}
Date: ${r.date}
Method: ${r.method}${r.txnId?(" | Txn: "+r.txnId):""}

Total: ${money(r.totalPrice)}
Advance Used: ${money(r.advanceUsed)}
Paid Now: ${money(r.paidNow)}
Remaining Due: ${money(r.remainingDue)}
Note: ${r.note||""}`;
}

async function shareReceipt(rid){
  const r = db.receipts.find(x=>x.id===rid);
  if(!r) return;
  const text = buildReceiptText(r);

  if(navigator.share){
    try{ await navigator.share({ title:`Payment Receipt #${r.receiptNo}`, text }); return; }catch(e){}
  }
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}
function copyReceipt(rid){
  const r = db.receipts.find(x=>x.id===rid);
  if(!r) return;
  navigator.clipboard.writeText(buildReceiptText(r)).then(()=>alert("Payment receipt copied ✅"));
}
function printReceipt(rid){
  const r = db.receipts.find(x=>x.id===rid);
  if(!r) return;
  const c = db.clients.find(x=>x.id===r.clientId);
  const j = db.jobs.find(x=>x.id===r.jobId);

  const html = `
  <html><head><meta charset="utf-8">
  <title>Payment Receipt #${r.receiptNo}</title>
  <style>
    body{font-family:Arial;padding:18px}
    .box{border:1px solid #ddd;border-radius:12px;padding:16px;max-width:520px}
    h2{margin:0 0 10px}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .muted{color:#555}
    hr{border:none;border-top:1px solid #eee;margin:12px 0}
  </style>
  </head><body>
    <div class="box">
      <h2>Payment Receipt #${r.receiptNo}</h2>
      <div class="row"><div class="muted">Client</div><div>${(c?c.name:"")}</div></div>
      <div class="row"><div class="muted">Job</div><div>${(j?j.title:"")}</div></div>
      <div class="row"><div class="muted">Date</div><div>${r.date}</div></div>
      <div class="row"><div class="muted">Method</div><div>${r.method} ${r.txnId?(" / "+r.txnId):""}</div></div>
      <hr/>
      <div class="row"><div class="muted">Total</div><div>${money(r.totalPrice)}</div></div>
      <div class="row"><div class="muted">Advance Used</div><div>${money(r.advanceUsed)}</div></div>
      <div class="row"><div class="muted">Paid Now</div><div>${money(r.paidNow)}</div></div>
      <div class="row"><div class="muted">Remaining Due</div><div>${money(r.remainingDue)}</div></div>
      <hr/>
      <div class="muted">Note</div>
      <div>${(r.note||"")}</div>
    </div>
    <script>window.print();<\/script>
  </body></html>`;

  const w = window.open("", "_blank");
  w.document.open(); w.document.write(html); w.document.close();
}
function deleteReceipt(rid){
  const ok = confirm("Payment receipt ডিলিট করবেন?");
  if(!ok) return;
  db.receipts = db.receipts.filter(r=>r.id!==rid);
  saveDB(db);
  renderAll();
}

/* ---------- Advance Receipt actions ---------- */
function buildAdvanceReceiptText(r){
  const c = db.clients.find(x=>x.id===r.clientId);
  return `ADVANCE RECEIPT #${r.receiptNo}
Client: ${c?c.name:""}
Date: ${r.date}
Amount: ${money(r.amount)}
Note: ${r.note||""}`;
}
async function shareAdvanceReceipt(rid){
  const r = (db.advanceReceipts||[]).find(x=>x.id===rid);
  if(!r) return;
  const text = buildAdvanceReceiptText(r);

  if(navigator.share){
    try{ await navigator.share({ title:`Advance Receipt #${r.receiptNo}`, text }); return; }catch(e){}
  }
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}
function copyAdvanceReceipt(rid){
  const r = (db.advanceReceipts||[]).find(x=>x.id===rid);
  if(!r) return;
  navigator.clipboard.writeText(buildAdvanceReceiptText(r)).then(()=>alert("Advance receipt copied ✅"));
}
function printAdvanceReceipt(rid){
  const r = (db.advanceReceipts||[]).find(x=>x.id===rid);
  if(!r) return;
  const c = db.clients.find(x=>x.id===r.clientId);

  const html = `
  <html><head><meta charset="utf-8">
  <title>Advance Receipt #${r.receiptNo}</title>
  <style>
    body{font-family:Arial;padding:18px}
    .box{border:1px solid #ddd;border-radius:12px;padding:16px;max-width:520px}
    h2{margin:0 0 10px}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .muted{color:#555}
    hr{border:none;border-top:1px solid #eee;margin:12px 0}
  </style>
  </head><body>
    <div class="box">
      <h2>Advance Receipt #${r.receiptNo}</h2>
      <div class="row"><div class="muted">Client</div><div>${(c?c.name:"")}</div></div>
      <div class="row"><div class="muted">Date</div><div>${r.date}</div></div>
      <hr/>
      <div class="row"><div class="muted">Amount</div><div>${money(r.amount)}</div></div>
      <hr/>
      <div class="muted">Note</div>
      <div>${(r.note||"")}</div>
    </div>
    <script>window.print();<\/script>
  </body></html>`;

  const w = window.open("", "_blank");
  w.document.open(); w.document.write(html); w.document.close();
}
function deleteAdvanceReceipt(rid){
  const ok = confirm("Advance receipt ডিলিট করবেন?");
  if(!ok) return;
  db.advanceReceipts = (db.advanceReceipts||[]).filter(r=>r.id!==rid);
  saveDB(db);
  renderAll();
}

/* ---------- Delete Job (with related) ---------- */
function deleteJob(jobId){
  const ok = confirm("এই Job ডিলিট করবেন? (Related payments & receiptsও ডিলিট হবে)");
  if(!ok) return;
  db.jobs = db.jobs.filter(j=>j.id!==jobId);
  db.payments = db.payments.filter(p=>p.jobId!==jobId);
  db.receipts = db.receipts.filter(r=>r.jobId!==jobId);
  saveDB(db);
  renderAll();
}

/* ---------- Start ---------- */
renderAll();
updateAdvancePreview();
</script>
</body>
</html>